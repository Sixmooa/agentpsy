<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人格测试 - 测试套件</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            margin: -30px -30px 20px -30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        
        .test-case {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }
        
        .test-case.failed {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .test-result {
            font-weight: bold;
            margin-top: 10px;
        }
        
        .test-result.passed {
            color: #28a745;
        }
        
        .test-result.failed {
            color: #dc3545;
        }
        
        .run-tests-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }
        
        .run-tests-btn:hover {
            background: #2980b9;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .console-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧠 人格测试系统 - TDD测试套件</h1>
            <p>全面测试所有核心功能模块，确保系统稳定性和准确性</p>
        </div>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <button class="run-tests-btn" onclick="runAllTests()">🚀 运行所有测试</button>
        </div>
        
        <div class="stats" id="test-stats">
            <div class="stat-item">
                <div class="stat-value" id="total-tests">0</div>
                <div class="stat-label">总测试数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="passed-tests">0</div>
                <div class="stat-label">通过</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="failed-tests">0</div>
                <div class="stat-label">失败</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="success-rate">0%</div>
                <div class="stat-label">成功率</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>📊 数据验证测试</h2>
            <div id="data-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>🧮 计算器功能测试</h2>
            <div id="calculator-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>💾 存储管理测试</h2>
            <div id="storage-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>🖼️ 图片生成测试</h2>
            <div id="image-tests"></div>
        </div>
        
        <div class="test-section">
            <h2>🔧 集成测试</h2>
            <div id="integration-tests"></div>
        </div>
        
        <div class="console-output" id="console-output"></div>
    </div>

    <!-- 引入所有模块 -->
    <script src="js/data.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/imageGenerator.js"></script>

    <script>
        // 测试框架
        class TestFramework {
            constructor() {
                this.tests = [];
                this.results = [];
                this.currentSection = '';
            }

            describe(sectionName, testFn) {
                this.currentSection = sectionName;
                testFn();
            }

            test(description, testFn) {
                this.tests.push({
                    section: this.currentSection,
                    description,
                    testFn
                });
            }

            expect(actual) {
                return {
                    toBe: (expected) => {
                        if (actual !== expected) {
                            throw new Error(`Expected ${expected}, but got ${actual}`);
                        }
                        return true;
                    },
                    toEqual: (expected) => {
                        if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                            throw new Error(`Expected ${JSON.stringify(expected)}, but got ${JSON.stringify(actual)}`);
                        }
                        return true;
                    },
                    toBeGreaterThan: (expected) => {
                        if (actual <= expected) {
                            throw new Error(`Expected ${actual} to be greater than ${expected}`);
                        }
                        return true;
                    },
                    toBeTruthy: () => {
                        if (!actual) {
                            throw new Error(`Expected ${actual} to be truthy`);
                        }
                        return true;
                    },
                    toBeFalsy: () => {
                        if (actual) {
                            throw new Error(`Expected ${actual} to be falsy`);
                        }
                        return true;
                    },
                    toContain: (expected) => {
                        if (!actual.includes(expected)) {
                            throw new Error(`Expected ${actual} to contain ${expected}`);
                        }
                        return true;
                    },
                    toHaveLength: (expected) => {
                        if (actual.length !== expected) {
                            throw new Error(`Expected length ${expected}, but got ${actual.length}`);
                        }
                        return true;
                    },
                    toBeInstanceOf: (expected) => {
                        if (!(actual instanceof expected)) {
                            throw new Error(`Expected ${actual} to be instance of ${expected.name}`);
                        }
                        return true;
                    }
                };
            }

            async runTests() {
                this.results = [];
                const startTime = Date.now();

                for (const test of this.tests) {
                    try {
                        await test.testFn();
                        this.results.push({
                            ...test,
                            passed: true,
                            error: null
                        });
                        this.logToConsole(`✅ ${test.description}`);
                    } catch (error) {
                        this.results.push({
                            ...test,
                            passed: false,
                            error: error.message
                        });
                        this.logToConsole(`❌ ${test.description}: ${error.message}`);
                    }
                }

                const endTime = Date.now();
                const duration = endTime - startTime;

                this.displayResults();
                this.logToConsole(`\n🏁 测试完成，耗时: ${duration}ms`);
            }

            displayResults() {
                const sections = ['data', 'calculator', 'storage', 'image', 'integration'];
                
                sections.forEach(section => {
                    const sectionTests = this.results.filter(r => r.section.toLowerCase().includes(section));
                    const container = document.getElementById(`${section}-tests`);
                    
                    if (container && sectionTests.length > 0) {
                        container.innerHTML = sectionTests.map(test => `
                            <div class="test-case ${test.passed ? 'passed' : 'failed'}">
                                <div>${test.description}</div>
                                <div class="test-result ${test.passed ? 'passed' : 'failed'}">
                                    ${test.passed ? '✅ 通过' : '❌ 失败'}
                                    ${test.error ? `: ${test.error}` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                });

                // 更新统计信息
                const total = this.results.length;
                const passed = this.results.filter(r => r.passed).length;
                const failed = total - passed;
                const successRate = total > 0 ? Math.round((passed / total) * 100) : 0;

                document.getElementById('total-tests').textContent = total;
                document.getElementById('passed-tests').textContent = passed;
                document.getElementById('failed-tests').textContent = failed;
                document.getElementById('success-rate').textContent = `${successRate}%`;
            }

            logToConsole(message) {
                const console = document.getElementById('console-output');
                console.textContent += message + '\n';
                console.scrollTop = console.scrollHeight;
            }
        }

        // 创建测试实例
        const testFramework = new TestFramework();

        // 数据验证测试
        testFramework.describe('数据验证', () => {
            testFramework.test('问题数据应该包含50个问题（中文）', () => {
                testFramework.expect(QUESTIONS_ZH).toHaveLength(50);
            });

            testFramework.test('问题数据应该包含50个问题（英文）', () => {
                testFramework.expect(QUESTIONS_EN).toHaveLength(50);
            });

            testFramework.test('每个维度应该有10个问题', () => {
                const dimensions = ['openness', 'conscientiousness', 'extraversion', 'agreeableness', 'neuroticism'];
                dimensions.forEach(dimension => {
                    const count = QUESTIONS_ZH.filter(q => q.dimension === dimension).length;
                    testFramework.expect(count).toBe(10);
                });
            });

            testFramework.test('贝尔宾角色数据应该完整', () => {
                testFramework.expect(Object.keys(BELBIN_ROLES)).toHaveLength(9);
                
                Object.values(BELBIN_ROLES).forEach(role => {
                    testFramework.expect(role.name).toBeTruthy();
                    testFramework.expect(role.description).toBeTruthy();
                    testFramework.expect(role.characteristics).toBeTruthy();
                });
            });

            testFramework.test('MBTI详情数据应该包含必要信息', () => {
                const sampleTypes = ['INTJ-A', 'ENTP-T', 'ISFP-A'];
                sampleTypes.forEach(type => {
                    if (MBTI_DETAILS[type]) {
                        const details = MBTI_DETAILS[type];
                        testFramework.expect(details.name).toBeTruthy();
                        testFramework.expect(details.description).toBeTruthy();
                        testFramework.expect(details.strengths).toBeInstanceOf(Array);
                    }
                });
            });
        });

        // 计算器功能测试
        testFramework.describe('计算器功能', () => {
            let calculator;

            testFramework.test('PersonalityCalculator应该能正确实例化', () => {
                calculator = new PersonalityCalculator();
                testFramework.expect(calculator).toBeInstanceOf(PersonalityCalculator);
                testFramework.expect(calculator.midPoint).toBe(3.0);
            });

            testFramework.test('应该能正确计算大五人格得分', () => {
                const answers = {
                    1: 4, 2: 5, 3: 3, 4: 4, 5: 2,
                    6: 4, 7: 5, 8: 2, 9: 4, 10: 2
                };
                const questions = QUESTIONS_ZH.slice(0, 10);
                
                const scores = calculator.calculateBigFiveScores(answers, questions);
                
                testFramework.expect(typeof scores).toBe('object');
                testFramework.expect(scores.openness).toBeGreaterThan(0);
                testFramework.expect(scores.conscientiousness).toBeGreaterThan(0);
            });

            testFramework.test('应该能正确计算MBTI类型', () => {
                const scores = {
                    openness: 4.2,
                    conscientiousness: 4.5,
                    extraversion: 2.8,
                    agreeableness: 3.9,
                    neuroticism: 2.1
                };
                
                const result = calculator.calculateMBTI(scores);
                
                testFramework.expect(result.type).toBeTruthy();
                testFramework.expect(result.typeCode).toBeTruthy();
                testFramework.expect(result.name).toBeTruthy();
                testFramework.expect(result.dimensions).toBeTruthy();
            });

            testFramework.test('应该能获取贝尔宾角色', () => {
                const roles = calculator.getBelbinRoles('INTJ');
                
                testFramework.expect(roles).toBeInstanceOf(Array);
                testFramework.expect(roles.length).toBeGreaterThan(0);
                testFramework.expect(roles[0].name).toBeTruthy();
            });

            testFramework.test('应该能验证答案完整性', () => {
                const completeAnswers = {};
                const incompleteAnswers = { 1: 4, 2: 5 };
                
                // 生成完整答案
                QUESTIONS_ZH.forEach(q => {
                    completeAnswers[q.id] = Math.floor(Math.random() * 5) + 1;
                });
                
                testFramework.expect(calculator.validateAnswers(completeAnswers, QUESTIONS_ZH)).toBeTruthy();
                testFramework.expect(calculator.validateAnswers(incompleteAnswers, QUESTIONS_ZH)).toBeFalsy();
            });

            testFramework.test('应该能正确计算进度', () => {
                const answers = { 1: 4, 2: 5, 3: 3 };
                const progress = calculator.getProgress(answers, QUESTIONS_ZH.slice(0, 10));
                
                testFramework.expect(progress.answered).toBe(3);
                testFramework.expect(progress.total).toBe(10);
                testFramework.expect(progress.percentage).toBe(30);
                testFramework.expect(progress.isComplete).toBeFalsy();
            });
        });

        // 存储管理测试
        testFramework.describe('存储管理', () => {
            let storage;

            testFramework.test('StorageManager应该能正确实例化', () => {
                storage = new StorageManager();
                testFramework.expect(storage).toBeInstanceOf(StorageManager);
                testFramework.expect(storage.storageKey).toBeTruthy();
            });

            testFramework.test('应该能检查存储可用性', () => {
                const isAvailable = storage.isStorageAvailable();
                testFramework.expect(typeof isAvailable).toBe('boolean');
            });

            testFramework.test('应该能保存和读取测试结果', () => {
                const testResult = {
                    mbtiResult: { type: 'INTJ-A', name: '建筑师' },
                    bigFiveScores: { openness: 4.2, conscientiousness: 4.5 },
                    timestamp: new Date().toISOString()
                };

                // 清空之前的结果
                storage.clearAllResults();
                
                const saved = storage.saveResult(testResult);
                if (storage.isStorageAvailable()) {
                    testFramework.expect(saved).toBeTruthy();
                    
                    const results = storage.getAllResults();
                    testFramework.expect(results).toBeInstanceOf(Array);
                    testFramework.expect(results.length).toBeGreaterThan(0);
                }
            });

            testFramework.test('应该能获取默认设置', () => {
                const settings = storage.getDefaultSettings();
                testFramework.expect(settings.language).toBeTruthy();
                testFramework.expect(settings.theme).toBeTruthy();
                testFramework.expect(typeof settings.autoSave).toBe('boolean');
            });

            testFramework.test('应该能生成唯一ID', () => {
                const id1 = storage.generateId();
                const id2 = storage.generateId();
                
                testFramework.expect(id1).toBeTruthy();
                testFramework.expect(id2).toBeTruthy();
                testFramework.expect(id1).not.toBe(id2);
            });
        });

        // 图片生成测试
        testFramework.describe('图片生成', () => {
            let imageGenerator;

            testFramework.test('ImageGenerator应该能正确实例化', () => {
                // 创建canvas元素
                if (!document.getElementById('result-canvas')) {
                    const canvas = document.createElement('canvas');
                    canvas.id = 'result-canvas';
                    canvas.style.display = 'none';
                    document.body.appendChild(canvas);
                }

                imageGenerator = new ImageGenerator();
                testFramework.expect(imageGenerator).toBeInstanceOf(ImageGenerator);
                testFramework.expect(imageGenerator.canvas).toBeTruthy();
                testFramework.expect(imageGenerator.ctx).toBeTruthy();
            });

            testFramework.test('应该能设置正确的画布尺寸', () => {
                testFramework.expect(imageGenerator.width).toBe(800);
                testFramework.expect(imageGenerator.height).toBe(1200);
                testFramework.expect(imageGenerator.canvas.width).toBe(800);
                testFramework.expect(imageGenerator.canvas.height).toBe(1200);
            });

            testFramework.test('应该能清空画布', () => {
                imageGenerator.clearCanvas();
                // 测试画布是否被清空（通过检查画布数据）
                const imageData = imageGenerator.ctx.getImageData(0, 0, 100, 100);
                const isEmpty = Array.from(imageData.data).every(value => value === 0);
                testFramework.expect(isEmpty).toBeTruthy();
            });

            testFramework.test('应该能生成测试结果图片', () => {
                const mockResult = {
                    mbtiResult: {
                        typeCode: 'INTJ',
                        name: '建筑师',
                        nameEn: 'Architect',
                        description: '富有想象力和战略性思想',
                        descriptionEn: 'Imaginative and strategic thinkers'
                    },
                    bigFiveScores: {
                        openness: 4.2,
                        conscientiousness: 4.5,
                        extraversion: 2.8,
                        agreeableness: 3.9,
                        neuroticism: 2.1
                    },
                    belbinRoles: [
                        {
                            name: '智多星',
                            nameEn: 'Plant',
                            description: '富有想象力和创造力',
                            descriptionEn: 'Creative and imaginative'
                        }
                    ],
                    careerSuggestions: ['科学家', '工程师', '研究员']
                };

                const imageData = imageGenerator.generateResultImage(mockResult, 'zh');
                testFramework.expect(imageData).toBeTruthy();
                testFramework.expect(imageData.startsWith('data:image/png;base64,')).toBeTruthy();
            });
        });

        // 集成测试
        testFramework.describe('集成测试', () => {
            testFramework.test('应该能完整执行测试流程', () => {
                const calculator = new PersonalityCalculator();
                const storage = new StorageManager();
                
                // 生成模拟答案
                const answers = {};
                QUESTIONS_ZH.forEach(q => {
                    answers[q.id] = Math.floor(Math.random() * 5) + 1;
                });

                // 生成报告
                const report = calculator.generateReport(answers, QUESTIONS_ZH, 'zh');
                
                testFramework.expect(report.bigFiveScores).toBeTruthy();
                testFramework.expect(report.mbtiResult).toBeTruthy();
                testFramework.expect(report.belbinRoles).toBeInstanceOf(Array);
                testFramework.expect(report.careerSuggestions).toBeInstanceOf(Array);
                testFramework.expect(report.timestamp).toBeTruthy();
                testFramework.expect(report.language).toBe('zh');

                // 保存结果
                if (storage.isStorageAvailable()) {
                    const saved = storage.saveResult(report);
                    testFramework.expect(saved).toBeTruthy();
                }
            });

            testFramework.test('应该能处理边界情况', () => {
                const calculator = new PersonalityCalculator();
                
                // 测试极端得分
                const extremeScores = {
                    openness: 5.0,
                    conscientiousness: 1.0,
                    extraversion: 5.0,
                    agreeableness: 1.0,
                    neuroticism: 5.0
                };
                
                const result = calculator.calculateMBTI(extremeScores);
                testFramework.expect(result.type).toBeTruthy();
                testFramework.expect(result.typeCode).toBeTruthy();
                
                // 测试空答案
                const progress = calculator.getProgress({}, QUESTIONS_ZH);
                testFramework.expect(progress.answered).toBe(0);
                testFramework.expect(progress.percentage).toBe(0);
                testFramework.expect(progress.isComplete).toBeFalsy();
            });

            testFramework.test('应该能处理多语言切换', () => {
                const calculator = new PersonalityCalculator();
                
                // 生成答案
                const answers = {};
                QUESTIONS_ZH.forEach(q => {
                    answers[q.id] = Math.floor(Math.random() * 5) + 1;
                });

                // 测试中文报告
                const reportZh = calculator.generateReport(answers, QUESTIONS_ZH, 'zh');
                testFramework.expect(reportZh.language).toBe('zh');
                
                // 测试英文报告
                const reportEn = calculator.generateReport(answers, QUESTIONS_EN, 'en');
                testFramework.expect(reportEn.language).toBe('en');
                
                // 结果应该一致（除了语言）
                testFramework.expect(reportZh.mbtiResult.typeCode).toBe(reportEn.mbtiResult.typeCode);
            });

            testFramework.test('应该能处理数据导入导出', () => {
                const storage = new StorageManager();
                
                if (!storage.isStorageAvailable()) {
                    return; // 跳过此测试如果存储不可用
                }

                // 清空并添加测试数据
                storage.clearAllResults();
                const testData = {
                    mbtiResult: { type: 'ENFP-T' },
                    bigFiveScores: { openness: 4.0 },
                    timestamp: new Date().toISOString()
                };
                
                storage.saveResult(testData);
                
                // 导出数据
                const exportedData = storage.exportData();
                testFramework.expect(exportedData).toBeTruthy();
                testFramework.expect(exportedData.includes('ENFP-T')).toBeTruthy();
                
                // 清空并导入数据
                storage.clearAllResults();
                const imported = storage.importData(exportedData);
                testFramework.expect(imported).toBeTruthy();
                
                const results = storage.getAllResults();
                testFramework.expect(results.length).toBeGreaterThan(0);
            });
        });

        // 运行所有测试的函数
        async function runAllTests() {
            const button = document.querySelector('.run-tests-btn');
            button.disabled = true;
            button.textContent = '🔄 运行中...';
            
            // 清空控制台输出
            document.getElementById('console-output').textContent = '';
            
            testFramework.logToConsole('🚀 开始运行测试套件...\n');
            
            try {
                await testFramework.runTests();
            } catch (error) {
                testFramework.logToConsole(`❌ 测试运行失败: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = '🚀 运行所有测试';
            }
        }

        // 页面加载完成后自动运行测试
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>